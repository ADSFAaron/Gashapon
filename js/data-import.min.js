let csvUrl,csvList,dataObjectArray,historyList=[],repeatDrawState=0,importModel="text",importState=0;function analyzeUrl(){let webUrl=location.search.slice(1).split("&"),webUrlData={csv:"",google:"",title:"",item:""};webUrl.forEach((param=>{param.includes("csv=")&&(document.querySelector(".hint-text .text").textContent="讀取中...",webUrlData.csv=param.replace("csv=",""),document.querySelector("#importUrl").value=webUrlData.csv,csvUrl=document.querySelector("#importUrl").value,fetchCsv(csvUrl)),param.includes("google=")&&(document.querySelector(".hint-text .text").textContent="讀取中...",webUrlData.google=param.replace("google=",""),document.querySelector("#importUrl").value=`https://docs.google.com/spreadsheets/d/e/${webUrlData.google}/pub?output=csv`,csvUrl=document.querySelector("#importUrl").value,fetchCsv(csvUrl)),param.includes("title=")&&(webUrlData.title=decodeURI(param.replace("title=",""))),!param.includes("item=")||param.includes("google=")||param.includes("csv=")||(webUrlData.item=decodeURI(param.replace("item=","")).replace(/__/g,"\n"),document.querySelector("#importText").value=webUrlData.item,importTextSuccess(webUrlData.item))}))}function fetchCsv(csvUrl){fetch(csvUrl).then((response=>response.text())).then((data=>{importCsvSuccess(data),hideButtons()})).catch((()=>{importCsvError()}))}function hideButtons(){document.querySelectorAll(".btn-import, .btn-display, .btn-instruction, .btn-about, .btn-share").forEach((button=>button.style.opacity="0"))}function importCsv(){const importCsvBtn=document.querySelector("#import-csv-btn"),importUrlInput=document.querySelector("#importUrl"),importCsvWarning=document.querySelector("#importCsvWarning");importCsvBtn.addEventListener("click",(function(){this.textContent="匯入中",csvUrl=importUrlInput.value,console.log("csvURL: ",csvUrl),""===csvUrl?(importUrlInput.parentElement.classList.add("warning"),importCsvWarning.textContent="此欄位不可空白。",importCsvWarning.style.display="block",this.textContent="確認"):fetch(csvUrl).then((response=>response.text())).then((data=>{importCsvSuccess(data),closeMenu(),modalState=0})).catch((error=>{console.log(error),importCsvError()}))}))}function importCsvSuccess(data){importModel="csv",csvList=data.split("\n");for(let i=0;i<csvList.length;i++)csvList[i]=csvList[i].trim().split(",");dataObjectArray=convertListToObjectArray(csvList),console.log("dataObjectArray: ",dataObjectArray),importState=1,closeModal(),document.querySelector(".hint-text .text").textContent="匯入成功",document.querySelector("#importUrl").parentElement.classList.remove("warning"),document.querySelector("#importCsvWarning").textContent="",document.querySelector("#importCsvWarning").style.display="none",document.querySelector("#import-csv-btn").textContent="確認",document.querySelector(".no-data-text").style.display="none",exportUrl("csv"),printGachaList()}function importCsvError(){importState=0,document.querySelector("#importUrl").parentElement.classList.add("warning"),document.querySelector("#import-csv-btn").textContent="確認",document.querySelector(".hint-text .text").textContent="匯入錯誤",document.querySelector("#importCsvWarning").textContent="網址匯入錯誤。",document.querySelector("#importCsvWarning").style.display="block",document.querySelector(".no-data-text").style.display="block"}function importText(){const importTextBtn=document.querySelector("#import-text-btn"),importTextInput=document.querySelector("#importText"),importTextWarning=document.querySelector("#importTextWarning");importTextBtn.addEventListener("click",(function(){this.textContent="匯入中";let textList=importTextInput.value;""===textList.replace(/\n/g,"").replace(/\r/g,"").replace(/ /g,"")?(importTextInput.parentElement.classList.add("warning"),importTextWarning.textContent="此欄位不可空白。",importTextWarning.style.display="block",this.textContent="確認"):(modalState=0,closeModal(),importTextSuccess(textList))}))}function importTextSuccess(textList){importModel="text",importState=1,csvList=(textList="項目\n"+textList).split("\n").map((item=>[item])),csvList=csvList.filter((item=>""!==item[0]&&"\n"!==item[0]&&" "!==item[0]&&" \n"!==item[0])),dataObjectArray=convertListToObjectArray(csvList),document.querySelector(".hint-text .text").textContent="匯入成功",document.querySelector("#importText").parentElement.classList.remove("warning"),document.querySelector("#importTextWarning").textContent="",document.querySelector("#importTextWarning").style.display="none",document.querySelector("#import-text-btn").textContent="確認",document.querySelector(".no-data-text").style.display="none",exportUrl("text"),printGachaList()}function convertListToObjectArray(list){const headers=list[0];return list.slice(1).map(((item,index)=>{const obj=headers.reduce(((acc,header,i)=>(acc[header]=item[i]||"",acc)),{});return obj.itemIsDrawn=!1,obj.itemId=`gacha-item-${index}`,obj.itemCount=0,obj}))}function exportUrl(type){let shareUrlInput=document.querySelector(".share-url"),hostname=location.href.replace(location.search,"");if("csv"===type){let urlParam=-1!==csvUrl.indexOf("https://docs.google.com/spreadsheets/d/e/")?`google=${csvUrl.replace("https://docs.google.com/spreadsheets/d/e/","").split("/")[0]}`:`csv=${csvUrl}`;shareUrlInput.value=`${hostname}?${urlParam}`}else if("text"===type){let itemText=document.querySelector("#importText").value.replace(/\n/g,"__");shareUrlInput.value=`${hostname}?item=${itemText}`}}analyzeUrl(),importCsv(),importText();const btnCopy=document.querySelector(".share-url-copy");function printGachaList(){const gachaList=document.querySelector("ul.gacha-list"),displayListGroup=document.querySelector(".display-list-group"),modalNoData=document.querySelector(".modal-body-display .modal-no-data"),displayModalReset=document.querySelector("#display-modal-reset");dataObjectArray?(displayListGroup.style.display="block",modalNoData.style.display="none",displayModalReset.style.display="flex",gachaList.innerHTML="",dataObjectArray.forEach((item=>{const key=Object.keys(item)[0],li=document.createElement("li");li.className="item",li.id=item.itemId,li.innerHTML=`<p class='item-name'>${item[key]}</p><p class='item-count'>${item.itemCount}</p>`,item.itemIsDrawn&&0===repeatDrawState&&li.classList.add("is-drawn"),gachaList.appendChild(li)}))):(gachaList.innerHTML="",displayListGroup.style.display="none",modalNoData.style.display="block",displayModalReset.style.display="none"),setGachaListBtnClickEvent()}function printHistoryList(){const historyListElement=document.querySelector("ul.history-list");historyListElement.innerHTML="",historyList.forEach(((item,index)=>{const li=document.createElement("li");li.className="item",li.innerHTML=`<p class='item-name'>${index+1}. ${item}</p>`,historyListElement.appendChild(li)}))}function repeatDraw(){const repeatDrawCheckbox=document.getElementById("repeat-draw"),gachaList=document.querySelector("ul.gacha-list"),repeatDrawLabel=document.querySelector(".repeat-draw");repeatDrawCheckbox.checked?(console.log("重複抽獎"),repeatDrawState=1,repeatDrawLabel.classList.add("checked"),gachaList.classList.add("repeat-draw-list"),gachaList.classList.remove("no-repeat-draw-list")):(console.log("不重複抽獎"),repeatDrawState=0,repeatDrawLabel.classList.remove("checked"),gachaList.classList.remove("repeat-draw-list"),gachaList.classList.add("no-repeat-draw-list"))}function setGachaListBtnClickEvent(){document.querySelectorAll(".gacha-list .item").forEach((item=>{item.addEventListener("click",(()=>{const id=item.id;if(console.log(id),0===repeatDrawState){item.classList.contains("is-drawn")?(item.classList.remove("is-drawn"),dataObjectArray.forEach((dataItem=>{dataItem.itemId===id&&(dataItem.itemIsDrawn=!1)}))):(item.classList.add("is-drawn"),dataObjectArray.forEach((dataItem=>{dataItem.itemId===id&&(dataItem.itemIsDrawn=!0)})))}}))}))}function resetDataObjectArray(){document.querySelectorAll(".gacha-list .item").forEach((item=>{item.classList.remove("active","is-drawn")})),dataObjectArray.forEach((item=>{item.itemIsDrawn=!1,item.itemCount=0})),printGachaList(),historyList=[];document.querySelector(".history-list").innerHTML="<li class='item'>暫無紀錄</li>",showModal("#display-modal")}function displayTabClickEvent(){const tabs=document.querySelectorAll("#display-modal .tab-list .tab"),tabPages=document.querySelectorAll("#display-modal .tab-page");tabs.forEach((tab=>{tab.addEventListener("click",(function(){tabs.forEach((sibling=>sibling.classList.remove("active"))),this.classList.add("active");const id=this.getAttribute("data-tab-page-id");tabPages.forEach((page=>page.classList.remove("active"))),document.querySelector(id).classList.add("active")}))}))}function importTabClickEvent(){const tabs=document.querySelectorAll("#import-modal .tab-list .tab"),tabPages=document.querySelectorAll("#import-modal .tab-page");tabs.forEach((tab=>{tab.addEventListener("click",(function(){tabs.forEach((sibling=>sibling.classList.remove("active"))),this.classList.add("active");const id=this.getAttribute("data-tab-page-id");tabPages.forEach((page=>page.classList.remove("active"))),document.querySelector(id).classList.add("active"),importModel="#import-csv"===id?"csv":"text",importBtnShowHide()}))}))}function importBtnShowHide(){const importCsvBtn=document.getElementById("import-csv-btn"),importTextBtn=document.getElementById("import-text-btn");"csv"===importModel?(importCsvBtn.style.display="flex",importTextBtn.style.display="none"):"text"===importModel&&(importCsvBtn.style.display="none",importTextBtn.style.display="flex")}btnCopy.addEventListener("click",(function(){const inputText=document.querySelector(".share-url");navigator.clipboard.writeText(inputText.value)})),printGachaList(),repeatDraw(),displayTabClickEvent(),importTabClickEvent(),importBtnShowHide();